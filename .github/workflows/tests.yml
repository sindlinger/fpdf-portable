name: FilterPDF Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  DOTNET_VERSION: '6.0.x'
  PROJECT_NAME: 'FilterPDF'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-suite: [unit, integration, security]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Restore dependencies
      run: dotnet restore FilterPDF.Tests.csproj
      
    - name: Build project
      run: dotnet build FilterPDFC#.csproj --configuration Release --no-restore
      
    - name: Build tests
      run: dotnet build FilterPDF.Tests.csproj --configuration Release --no-restore
      
    - name: Run ${{ matrix.test-suite }} tests
      run: ./test.sh ${{ matrix.test-suite }}
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.test-suite }}
        path: TestResults/**/*.trx
        retention-days: 30
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: matrix.test-suite == 'unit'
      with:
        name: coverage-report
        path: Coverage/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install security scanner
      run: dotnet tool install --global security-scan
      
    - name: Run security scan
      run: security-scan FilterPDFC#.csproj --export sarif --output security-results.sarif
      continue-on-error: true
      
    - name: Upload security results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: security-results.sarif

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore and build
      run: |
        dotnet restore FilterPDF.Tests.csproj
        dotnet build FilterPDFC#.csproj --configuration Release --no-restore
        dotnet build FilterPDF.Tests.csproj --configuration Release --no-restore
        
    - name: Run performance tests
      run: ./test.sh performance
      
    - name: Upload performance results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: TestResults/**/*performance*.trx
        retention-days: 30

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache SonarCloud packages
      uses: actions/cache@v3
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
        
    - name: Install SonarCloud scanner
      run: dotnet tool install --global dotnet-sonarscanner
      
    - name: Build and analyze
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner begin /k:"${{ github.repository_owner }}_${{ github.event.repository.name }}" /o:"${{ github.repository_owner }}" /d:sonar.login="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
        dotnet build FilterPDFC#.csproj --configuration Release
        dotnet test FilterPDF.Tests.csproj --configuration Release --collect:"XPlat Code Coverage" --results-directory TestResults/ -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

  integration-full:
    name: Full Integration Test
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Create test PDFs
      run: |
        mkdir -p TestData
        echo -e "%PDF-1.4\n1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\ntrailer\n<<\n/Root 1 0 R\n>>\n%%EOF" > TestData/test.pdf
        
    - name: Build and publish
      run: |
        dotnet restore FilterPDF.Tests.csproj
        dotnet build FilterPDFC#.csproj --configuration Release --no-restore
        dotnet publish FilterPDFC#.csproj -c Release
        
    - name: Test executable
      run: |
        ./bin/fpdf --help
        ./bin/fpdf --version
        
    - name: Test with sample PDF
      run: |
        ./bin/fpdf TestData/test.pdf load --text
        ./bin/fpdf cache list
        ./bin/fpdf 1 filter pages --format count
        
    - name: Run comprehensive test suite
      run: ./test.sh all
      
    - name: Archive test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: comprehensive-test-results
        path: |
          TestResults/
          Coverage/
          *.log
        retention-days: 30

  release-readiness:
    name: Release Readiness Check
    runs-on: ubuntu-latest
    needs: [test, security-scan, performance, code-quality, integration-full]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Check test coverage
      run: |
        if [ -f coverage-report/Summary.txt ]; then
          COVERAGE=$(grep "Line coverage:" coverage-report/Summary.txt | grep -o "[0-9.]*%" | head -1)
          echo "Test coverage: $COVERAGE"
          if [ "${COVERAGE%.*}" -lt "80" ]; then
            echo "‚ùå Test coverage below 80% threshold"
            exit 1
          else
            echo "‚úÖ Test coverage meets requirements"
          fi
        else
          echo "‚ö†Ô∏è Coverage report not found"
        fi
        
    - name: Validate test results
      run: |
        FAILED_TESTS=0
        for result_file in test-results-*/unit-tests.trx test-results-*/integration-tests.trx test-results-*/security-tests.trx; do
          if [ -f "$result_file" ]; then
            FAILED=$(grep -o 'failed="[0-9]*"' "$result_file" | grep -o '[0-9]*' || echo "0")
            FAILED_TESTS=$((FAILED_TESTS + FAILED))
          fi
        done
        
        if [ $FAILED_TESTS -gt 0 ]; then
          echo "‚ùå $FAILED_TESTS test(s) failed"
          exit 1
        else
          echo "‚úÖ All tests passed"
        fi
        
    - name: Release readiness summary
      run: |
        echo "üéâ Release readiness check completed successfully!"
        echo "‚úÖ All test suites passed"
        echo "‚úÖ Security scans completed"
        echo "‚úÖ Code quality analysis passed"
        echo "‚úÖ Integration tests successful"